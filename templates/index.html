<!doctype html>
<head>
    <title>Upload new File</title>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        .file-browser { 
            border: 1px solid #ccc; 
            padding: 20px; 
            margin: 20px 0; 
            max-height: 400px; 
            overflow-y: auto; 
            background-color: #f9f9f9;
        }
        .file-browser ul { list-style-type: none; padding-left: 20px; }
        .file-browser li { margin: 5px 0; }
        .file-browser a { text-decoration: none; color: #007bff; cursor: pointer; }
        .file-browser a:hover { text-decoration: underline; }
        .dir { font-weight: bold; }
        .file { color: #28a745; }
        .actions { margin: 10px 0; }
        .actions button, .actions input[type="submit"] {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        .actions .confirm-btn { background-color: #28a745; color: white; }
        .actions .create-btn { background-color: #007bff; color: white; }
        .browse-toggle { background-color: #6c757d; color: white; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; }
        #drop-zone {
            border: 2px dashed #ccc;
            border-radius: 20px;
            width: 300px;
            height: 200px;
            padding: 20px;
            text-align: center;
            font: 20pt bold 'Vollkorn';
            color: #ccc;
        }
        #drop-zone.dragover {
            border-color: #000;
            color: #000;
        }
    </style>
</head>
<body>
<h1>Upload new File</h1>

<div id="file-browser-container" style="display: none;">
    <h3>File Browser</h3>
    <div class="file-browser">
        <p>Current Path: <span id="current-path-display">/home</span></p>
        <div class="actions">
            <button class="confirm-btn" onclick="confirmPath()">Confirm This Path</button>
            <input type="text" id="new-folder-name" placeholder="New folder name">
            <button class="create-btn" onclick="createFolder()">Create Folder</button>
        </div>
        <div id="browser-content">
            <!-- Directory content will be loaded here -->
        </div>
    </div>
</div>

<form method=post enctype=multipart/form-data>
  <p>
    <label for="path">Path to store file:</label>
    <input type="text" name="path" id="path" value="uploads">
    <button type="button" class="browse-toggle" onclick="toggleBrowser()">Browse</button>
  </p>
  <p>
    <input type=file name=file>
    <input type=submit value=Upload>
  </p>
</form>
<div id="drop-zone">Drop files here</div>
<script>
var currentPath = '';

function toggleBrowser() {
    var container = document.getElementById('file-browser-container');
    if (container.style.display === 'none') {
        container.style.display = 'block';
        loadDirectory('');
    } else {
        container.style.display = 'none';
    }
}

function loadDirectory(path) {
    currentPath = path;
    fetch('/api/browse?path=' + encodeURIComponent(path))
        .then(response => response.json())
        .then(data => {
            document.getElementById('current-path-display').textContent = data.current_path;
            var content = '';
            
            if (path) {
                content += '<a onclick="loadDirectory(\'' + data.parent_path + '\')" class="dir">.. (Parent Directory)</a><br>';
            }
            
            data.dirs.forEach(function(dir) {
                var newPath = path ? path + '/' + dir : dir;
                content += '<a onclick="loadDirectory(\'' + newPath + '\')" class="dir">' + dir + '/</a><br>';
            });
            
            data.files.forEach(function(file) {
                content += '<span class="file">' + file + '</span><br>';
            });
            
            document.getElementById('browser-content').innerHTML = content;
        });
}

function confirmPath() {
    var path = document.getElementById('current-path-display').textContent;
    document.getElementById('path').value = path;
    document.getElementById('file-browser-container').style.display = 'none';
}

function createFolder() {
    var folderName = document.getElementById('new-folder-name').value;
    if (!folderName) {
        alert('Please enter a folder name');
        return;
    }
    
    fetch('/api/create_folder', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'path=' + encodeURIComponent(currentPath) + '&folder_name=' + encodeURIComponent(folderName)
    })
    .then(response => {
        if (response.ok) {
            document.getElementById('new-folder-name').value = '';
            loadDirectory(currentPath);
        } else {
            alert('Error creating folder');
        }
    });
}

var dropZone = document.getElementById('drop-zone');
var uploadForm = document.querySelector('form');

dropZone.addEventListener('dragover', function(e) {
  e.preventDefault();
  e.stopPropagation();
  dropZone.classList.add('dragover');
});

dropZone.addEventListener('dragleave', function(e) {
  e.preventDefault();
  e.stopPropagation();
  dropZone.classList.remove('dragover');
});

dropZone.addEventListener('drop', function(e) {
  e.preventDefault();
  e.stopPropagation();
  dropZone.classList.remove('dragover');

  var files = e.dataTransfer.files;
  if (files.length > 0) {
    uploadForm.elements.file.files = files;
    uploadForm.submit();
  }
});
</script>
</body>
</html>
